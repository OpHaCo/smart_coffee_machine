import java.text.SimpleDateFormat
import java.util.Date
import org.openhab.core.library.types.*

rule StartupSqRules
when System started
then
logInfo("rules", "startup squeezebox rules")
end

rule slack_message

/** Message to like a music played on squeezebox server */
when Item SlackMessage received command
then
	logInfo("rules", "try to find Title ...")
	var String slackUser = receivedCommand.toString().split(":").get(0)
	var String user = transform("MAP","slack_users.map", slackUser)
	
	if(user.blank)
	{
		logInfo("rules", "no mapping found in slack users- exiting")
		return false
	}
	else if(!receivedCommand.toString().endsWith("+1"))
	{
		logInfo("rules", "Slack command not handled")
		return false
	}

	var String trackInfo
	/**play a sound indicating track has been liked */
	logInfo("rules", executeCommandLine("./configurations/helper_scripts/play_sound.sh ./sounds/cloche.mp3", 1000000))
	trackInfo = executeCommandLine("/home/remi/projects/shazam_on_linux/shazam.sh /home/remi/projects/shazam_on_linux/shazam_on_linux_remi.conf", 1000000)
	if(trackInfo == 'None')
	{
		trackInfo = "Sorry... le titre de ton kif n'est pas dispo..."
	}
	sendCommand(Slack, '{"user" : "' + transform("MAP","slack_users_webhooks.map", user)+ '",' +  
                             '"trackInfo" : "' + trackInfo + '"}')
end

rule slaskbot
when Item Slack received command
then
	var String webHookURL = transform("JSONPATH", "$.user", receivedCommand.toString())
	var String trackInfo = transform("JSONPATH", "$.trackInfo", receivedCommand.toString())
 	sendHttpPostRequest(webHookURL , "text/plain" ,"{\"text\": \"" + trackInfo + "\" }")
 end